<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Building a True OAuth 2.0 API with Django and Tasty Pie</title>
        <meta name="description" content="">
        <meta name="author" content="Ian Alexander">
		<link href="http://feeds.feedburner.com/ianalexandr" rel="alternate" title="Ian Alexander" type="application/atom+xml" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" href="/media/css/bootstrap.css">

        <style>
            body {
                padding-top: 60px;
                padding-bottom: 40px;
            }
        </style>

        <link rel="stylesheet" href="/media/css/bootstrap-responsive.css">
        <link rel="stylesheet" href="/media/css/main.css">
        <link rel="stylesheet" href="/media/css/pygments.css">

        <script src="/media/js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script>
        <meta name="google-site-verification" content="BKR9TZ7BJUDYLzFZwFg6I5P-oOCnmYvetxlA474ab2Y" />
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div class="container">
            <div class="row">
                <div class="span8 offset2">
                    <p id="navigation">
                        <a href="https://www.facebook.com/ian.m.alexander" onclick="clickme('facebook');">facebook</a> /
                        <a href="https://twitter.com/ianalexan" onclick="clickme('twitter');">twitter</a> /
                        <a href="https://www.linkedin.com/in/ianmalexander" onclick="clickme('linkedin');">linkedin</a> /
                        <a href="http://www.quora.com/Ian-Alexander-5/answers" onclick="clickme('quora');">quora</a> /
                        <a href="https://github.com/ianalexander" onclick="clickme('github');">github</a> /
                        <a href="http://instagram.com/ianalexan" onclick="clickme('instagram');">instagram</a>
                        </br>
                        <a href="/blog">blog</a> <!-- &mdash; -->
                    </p>
                </div>
            </div>
        </div>

        <div class="container">
                        <div class="row">
                <div class="span8 offset2">
                    <h2 class="post-title">Building a True OAuth 2.0 API with Django and Tasty Pie</h2>
    <p class="post-info">
        posted by Ian on April 10, 2013
    </p>

    <p>Almost a year ago PyDanny wrote a great article entitled &#8220;<a href="http://pydanny.com/the-sorry-state-of-python-oauth-providers.html">The Sorry State of Python OAuth Providers</a>&#8221; detailing the abysmal state of OAuth in Python. One year later we have a few more options, and here I am going to detail how I made a django-based OAuth 2.0 <span class="caps">API</span> with Tasty&nbsp;Pie.</p>
<h2>Getting&nbsp;Started</h2>
<p>First things first, I cannot recommend enough the <a href="https://github.com/Mashape/mashape-oauth/blob/master/FLOWS.md">Mashape OAuth Bible</a> enough. It is currently the most comprehensive document I have found covering both OAuth 1 and 2, and the various flows involved with each. Read up before you get started! We&#8217;ll be using various components to put our <span class="caps">API</span>&nbsp;together:</p>
<ul>
<li>CaffieneHit&#8217;s <a href="https://github.com/caffeinehit/django-oauth2-provider">django-oauth2-provider</a> library will provide out-of-the-box OAuth provisioning&nbsp;capabilities </li>
<li><a href="http://tastypieapi.org/">Tasty Pie</a> will create the&nbsp;<span class="caps">API</span></li>
<li>My <a href="https://github.com/ianalexander/django-oauth2-tastypie">django-oauth2-tastypie</a> library will marry the two&nbsp;together</li>
</ul>
<p>I&#8217;ll be using the classic django &#8220;Polls and Choices&#8221; models as my&nbsp;examples.</p>
<h2>Setting up&nbsp;Django</h2>
<p>First things first, we need to create a new django project and create the essential&nbsp;models.</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="nv">$ </span>django-admin.py startproject mysite<br /><span class="nv">$ </span><span class="nb">cd </span>mysite/<br /><span class="nv">$ </span>python manage.py startapp polls<br /></pre></div><br /><figcaption>Bash</figcaption></figure></div>

<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="c"># mysite/polls/models.py</span><br /><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span><br />&nbsp;<br /><span class="k">class</span> <span class="nc">Poll</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span><br />    <span class="n">question</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span><br />    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="s">&#39;date published&#39;</span><span class="p">)</span><br />    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br />        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span><br />&nbsp;<br /><span class="k">class</span> <span class="nc">Choice</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span><br />    <span class="n">poll</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Poll</span><span class="p">)</span><br />    <span class="n">choice_text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span><br />    <span class="n">votes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><br />    <span class="k">def</span> <span class="nf">__unicode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><br />        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">choice_text</span><br /></pre></div><br /><figcaption>Python</figcaption></figure></div>

<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="c"># mysite/polls/settings.py</span><br /><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span><br />    <span class="o">...</span><br />    <span class="s">&#39;django.contrib.admin&#39;</span><br />    <span class="s">&#39;polls&#39;</span><span class="p">,</span><br /><span class="p">)</span><br /></pre></div><br /><figcaption>Python</figcaption></figure></div>

<p>Make sure you also add your database configuration and syncdb to add a new user. No surprises&nbsp;here!</p>
<h2>Setting up the&nbsp;Provider</h2>
<p>First we&#8217;re going to install the&nbsp;provider.</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="nv">$ </span>sudo pip install django-oauth2-provider<br /></pre></div><br /><figcaption>Bash</figcaption></figure></div>

<p>Next, add the two lines to add the default providers (which should be fine for most&nbsp;use-cases).</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="c"># mysite/polls/settings.py</span><br /><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span><br />    <span class="o">...</span><br />    <span class="s">&#39;django.contrib.admin&#39;</span><br />    <span class="s">&#39;polls&#39;</span><span class="p">,</span><br />    <span class="s">&#39;provider&#39;</span><span class="p">,</span><br />    <span class="s">&#39;provider.oauth2&#39;</span><span class="p">,</span><br /><span class="p">)</span><br /></pre></div><br /><figcaption>Python</figcaption></figure></div>

<p>Include provider.oauth2.urls into your urls.py file (<code>namespace='oauth2'</code> is required!). Uncomment the admin lines at the top of the file for ease of working with tokens and&nbsp;clients.</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="c"># mysite/polls/urls.py</span><br /><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span><br /><span class="n">admin</span><span class="o">.</span><span class="n">autodiscover</span><span class="p">()</span><br /><span class="o">...</span><br /><span class="n">url</span><span class="p">(</span><span class="s">r&#39;^oauth2/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">&#39;provider.oauth2.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span> <span class="o">=</span> <span class="s">&#39;oauth2&#39;</span><span class="p">)),</span><br /></pre></div><br /><figcaption>Python</figcaption></figure></div>

<p>Finally, use the admin console to add a new Client. Or you can do it&nbsp;programatically:</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">provider.oauth2.models</span> <span class="kn">import</span> <span class="n">Client</span><br /><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span><br /><span class="gp">&gt;&gt;&gt; </span><span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><br /><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">u</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;mysite client&quot;</span><span class="p">,</span> <span class="n">client_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s">&quot;http://ianalexandr.com&quot;</span><span class="p">)</span><br /><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">save</span><span class="p">()</span><br /><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">client_id</span><br /><span class="go">&#39;d63f53a7a6cceba04db5&#39;</span><br /><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">client_secret</span><br /><span class="go">&#39;afe899288b9ac4127d57f2f12ac5a49d839364dc&#39;</span><br /></pre></div><br /><figcaption>Python console session</figcaption></figure></div>

<h2>Testing the&nbsp;Provider</h2>
<p>Now we can launch the server and test the OAuth Provider. We&#8217;ll be using the <a href="https://github.com/Mashape/mashape-oauth/blob/master/FLOWS.md#oauth-2-two-legged">Two-Legged Resource Owner Password</a>&nbsp;flow.</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="nv">$ </span>python manage.py runserver<br />&nbsp;<br /><span class="nv">$ </span>curl -d <span class="s2">&quot;client_id=d63f53a7a6cceba04db5&amp;client_secret=afe899288b9ac4127d57f2f12ac5a49d839364dc&amp;grant_type=password&amp;username=ian&amp;password=straightflexin&amp;scope=write&quot;</span> http://localhost:8000/oauth2/access_token<br /><span class="o">{</span><span class="s2">&quot;access_token&quot;</span>: <span class="s2">&quot;a832106c17d00fd3b9094181c598820ef3ff76f4&quot;</span>, <span class="s2">&quot;scope&quot;</span>: <span class="s2">&quot;read write&quot;</span>, <span class="s2">&quot;expires_in&quot;</span>: 86399, <span class="s2">&quot;refresh_token&quot;</span>: <span class="s2">&quot;bfdbd5510ae724a2dbd458e68274ab5c8590d3e4&quot;</span><span class="o">}</span><br /></pre></div><br /><figcaption>Bash</figcaption></figure></div>

<p>If you see the access_token, voila! It&#8217;s working! Verify the access_token is stored in your&nbsp;database:</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">provider.oauth2.models</span> <span class="kn">import</span> <span class="n">AccessToken</span><br /><span class="gp">&gt;&gt;&gt; </span><span class="n">AccessToken</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><br /><span class="go">[&lt;AccessToken: a832106c17d00fd3b9094181c598820ef3ff76f4&gt;]</span><br /></pre></div><br /><figcaption>Python console session</figcaption></figure></div>

<h2>Setting up the&nbsp;<span class="caps">API</span></h2>
<p>Now let&#8217;s add Tasty Pie to the mix. First things&nbsp;first:</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="nv">$ </span>sudo pip install django-tastypie<br /></pre></div><br /><figcaption>Bash</figcaption></figure></div>

<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="c"># mysite/polls/settings.py</span><br /><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span><br />    <span class="o">...</span><br />    <span class="s">&#39;django.contrib.admin&#39;</span><br />    <span class="s">&#39;polls&#39;</span><span class="p">,</span><br />    <span class="s">&#39;provider&#39;</span><span class="p">,</span><br />    <span class="s">&#39;provider.oauth2&#39;</span><span class="p">,</span><br />    <span class="s">&#39;tastypie&#39;</span><span class="p">,</span><br /><span class="p">)</span><br /></pre></div><br /><figcaption>Python</figcaption></figure></div>

<p>Now we need to add the appropriate Resources to our to our application. I like to use <code>polls/api.py</code> but these classes can live anywhere. Once the Resources are created, we&#8217;ll add them to our <code>urls.py</code> using the <code>Api()</code> class to bind multiple resources&nbsp;together.</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="c"># mysite/polls/api.py</span><br /><span class="kn">from</span> <span class="nn">tastypie.resources</span> <span class="kn">import</span> <span class="n">ModelResource</span><br /><span class="kn">from</span> <span class="nn">polls.models</span> <span class="kn">import</span> <span class="n">Poll</span><span class="p">,</span> <span class="n">Choice</span><br /><span class="kn">from</span> <span class="nn">tastypie</span> <span class="kn">import</span> <span class="n">fields</span><br />&nbsp;<br /><span class="k">class</span> <span class="nc">ChoiceResource</span><span class="p">(</span><span class="n">ModelResource</span><span class="p">):</span><br />    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span><br />        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Choice</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><br />        <span class="n">resource_name</span> <span class="o">=</span> <span class="s">&#39;choice&#39;</span><br />&nbsp;<br /><span class="k">class</span> <span class="nc">PollResource</span><span class="p">(</span><span class="n">ModelResource</span><span class="p">):</span><br />    <span class="n">choices</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">ToManyField</span><span class="p">(</span><span class="n">ChoiceResource</span><span class="p">,</span> <span class="s">&#39;choice_set&#39;</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><br />    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span><br />        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Poll</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><br />        <span class="n">resource_name</span> <span class="o">=</span> <span class="s">&#39;poll&#39;</span><br /></pre></div><br /><figcaption>Python</figcaption></figure></div>

<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="c"># mysite/mysite/urls.py</span><br /><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span><br /><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span><br /><span class="n">admin</span><span class="o">.</span><span class="n">autodiscover</span><span class="p">()</span><br />&nbsp;<br /><span class="kn">from</span> <span class="nn">tastypie.api</span> <span class="kn">import</span> <span class="n">Api</span><br /><span class="kn">from</span> <span class="nn">polls.api</span> <span class="kn">import</span> <span class="n">PollResource</span><span class="p">,</span> <span class="n">ChoiceResource</span><br />&nbsp;<br /><span class="n">v1_api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">api_name</span><span class="o">=</span><span class="s">&#39;v1&#39;</span><span class="p">)</span><br /><span class="n">v1_api</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">PollResource</span><span class="p">())</span><br /><span class="n">v1_api</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ChoiceResource</span><span class="p">())</span><br />&nbsp;<br /><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><br />    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span><br />    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^oauth2/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">&#39;provider.oauth2.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span> <span class="o">=</span> <span class="s">&#39;oauth2&#39;</span><span class="p">)),</span><br />    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^api/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">v1_api</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span><br /><span class="p">)</span><br /></pre></div><br /><figcaption>Python</figcaption></figure></div>

<p>Now let&#8217;s test our our&nbsp;<span class="caps">API</span>!</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="nv">$ </span>curl http://127.0.0.1:8000/api/v1/?format<span class="o">=</span>json<br /><span class="o">{</span><span class="s2">&quot;choice&quot;</span>: <span class="o">{</span><span class="s2">&quot;list_endpoint&quot;</span>: <span class="s2">&quot;/api/v1/choice/&quot;</span>, <span class="s2">&quot;schema&quot;</span>: <span class="s2">&quot;/api/v1/choice/schema/&quot;</span><span class="o">}</span>, <span class="s2">&quot;poll&quot;</span>: <span class="o">{</span><span class="s2">&quot;list_endpoint&quot;</span>: <span class="s2">&quot;/api/v1/poll/&quot;</span>, <span class="s2">&quot;schema&quot;</span>: <span class="s2">&quot;/api/v1/poll/schema/&quot;</span><span class="o">}}</span><br /></pre></div><br /><figcaption>Bash</figcaption></figure></div>

<p>Looks like it&#8217;s working, let&#8217;s add an object and test the other&nbsp;endpoints:</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">polls.models</span> <span class="kn">import</span> <span class="o">*</span><br /><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">datetime</span><br /><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Poll</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s">&quot;All gold everything?&quot;</span><span class="p">,</span> <span class="n">pub_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><br /><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">choice_set</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">choice_text</span><span class="o">=</span><span class="s">&#39;Chain&#39;</span><span class="p">,</span> <span class="n">votes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><br /><span class="go">&lt;Choice: Choice object&gt;</span><br /><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">choice_set</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">choice_text</span><span class="o">=</span><span class="s">&#39;Ring&#39;</span><span class="p">,</span> <span class="n">votes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><br /><span class="go">&lt;Choice: Choice object&gt;</span><br /><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">choice_set</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">choice_text</span><span class="o">=</span><span class="s">&#39;Watch&#39;</span><span class="p">,</span> <span class="n">votes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><br /><span class="go">&lt;Choice: Choice object&gt;</span><br /><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">()</span><br /></pre></div><br /><figcaption>Python console session</figcaption></figure></div>

<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="nv">$ </span>curl http://127.0.0.1:8000/api/v1/poll/?format<span class="o">=</span>json<br /><span class="o">{</span><span class="s2">&quot;meta&quot;</span>: <span class="o">{</span><span class="s2">&quot;limit&quot;</span>: 20, <span class="s2">&quot;next&quot;</span>: null, <span class="s2">&quot;offset&quot;</span>: 0, <span class="s2">&quot;previous&quot;</span>: null, <span class="s2">&quot;total_count&quot;</span>: 1<span class="o">}</span>, <span class="s2">&quot;objects&quot;</span>: <span class="o">[{</span><span class="s2">&quot;choices&quot;</span>: <span class="o">[{</span><span class="s2">&quot;choice_text&quot;</span>: <span class="s2">&quot;Chain&quot;</span>, <span class="s2">&quot;id&quot;</span>: 1, <span class="s2">&quot;resource_uri&quot;</span>: <span class="s2">&quot;/api/v1/choice/1/&quot;</span>, <span class="s2">&quot;votes&quot;</span>: 0<span class="o">}</span>, <span class="o">{</span><span class="s2">&quot;choice_text&quot;</span>: <span class="s2">&quot;Ring&quot;</span>, <span class="s2">&quot;id&quot;</span>: 2, <span class="s2">&quot;resource_uri&quot;</span>: <span class="s2">&quot;/api/v1/choice/2/&quot;</span>, <span class="s2">&quot;votes&quot;</span>: 0<span class="o">}</span>, <span class="o">{</span><span class="s2">&quot;choice_text&quot;</span>: <span class="s2">&quot;Watch&quot;</span>, <span class="s2">&quot;id&quot;</span>: 3, <span class="s2">&quot;resource_uri&quot;</span>: <span class="s2">&quot;/api/v1/choice/3/&quot;</span>, <span class="s2">&quot;votes&quot;</span>: 0<span class="o">}]</span>, <span class="s2">&quot;id&quot;</span>: 1, <span class="s2">&quot;pub_date&quot;</span>: <span class="s2">&quot;2013-04-10T12:38:47.337475&quot;</span>, <span class="s2">&quot;question&quot;</span>: <span class="s2">&quot;All gold everything?&quot;</span>, <span class="s2">&quot;resource_uri&quot;</span>: <span class="s2">&quot;/api/v1/poll/1/&quot;</span><span class="o">}]}</span><br /></pre></div><br /><figcaption>Bash</figcaption></figure></div>

<h2>Authenticating with&nbsp;django-oauth2-tastypie</h2>
<p>Now we have an OAuth 2.0 provider and an <span class="caps">API</span>. Next we&#8217;ll need to tell Tasty Pie to accept tokens, and to use django-oauth2-provider to validate the&nbsp;tokens.</p>
<p>Briefly before we get started: what is the difference between <strong>authentication</strong> and <strong>authorization</strong>? <strong>Authentication</strong> answers the question, &#8220;Who is this person?&#8221; Authentication deals with usernames and passwords, OAuth Tokens, <span class="caps">API</span> Keys, and other means of identification. <strong>Authorization</strong> answers the question &#8220;Is this person allowed to perfom this action&#8221;? Authorizaton deals with permissions, and access&nbsp;limitations.</p>
<p>First take a look at the <code>OAuth20Authentication</code> class in <a href="https://github.com/ianalexander/django-oauth2-tastypie">django-oauth2-tastypie</a>. Copy (or clone) <code>authenticate.py</code> into your <code>mysite/polls/</code> directory.</p>
<p>Next, modify your <code>api.py</code> file to use the new <code>Authentication</code> class (and the <code>DjangoAuthrorization</code> class for good&nbsp;measure).</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="c"># mysite/polls/api.py</span><br /><span class="kn">from</span> <span class="nn">tastypie.resources</span> <span class="kn">import</span> <span class="n">ModelResource</span><br /><span class="kn">from</span> <span class="nn">tastypie.authorization</span> <span class="kn">import</span> <span class="n">DjangoAuthorization</span><br /><span class="kn">from</span> <span class="nn">polls.models</span> <span class="kn">import</span> <span class="n">Poll</span><span class="p">,</span> <span class="n">Choice</span><br /><span class="kn">from</span> <span class="nn">tastypie</span> <span class="kn">import</span> <span class="n">fields</span><br /><span class="kn">from</span> <span class="nn">authentication</span> <span class="kn">import</span> <span class="n">OAuth20Authentication</span><br />&nbsp;<br /><span class="k">class</span> <span class="nc">ChoiceResource</span><span class="p">(</span><span class="n">ModelResource</span><span class="p">):</span><br />    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span><br />        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Choice</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><br />        <span class="n">resource_name</span> <span class="o">=</span> <span class="s">&#39;choice&#39;</span><br />        <span class="n">authorization</span> <span class="o">=</span> <span class="n">DjangoAuthorization</span><span class="p">()</span><br />        <span class="n">authentication</span> <span class="o">=</span> <span class="n">OAuth20Authentication</span><span class="p">()</span><br />&nbsp;<br /><span class="k">class</span> <span class="nc">PollResource</span><span class="p">(</span><span class="n">ModelResource</span><span class="p">):</span><br />    <span class="n">choices</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">ToManyField</span><span class="p">(</span><span class="n">ChoiceResource</span><span class="p">,</span> <span class="s">&#39;choice_set&#39;</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><br />    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span><br />        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Poll</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><br />        <span class="n">resource_name</span> <span class="o">=</span> <span class="s">&#39;poll&#39;</span><br />        <span class="n">authorization</span> <span class="o">=</span> <span class="n">DjangoAuthorization</span><span class="p">()</span><br />        <span class="n">authentication</span> <span class="o">=</span> <span class="n">OAuth20Authentication</span><span class="p">()</span><br /></pre></div><br /><figcaption>Python</figcaption></figure></div>

<p>Now let&#8217;s try to access our <span class="caps">API</span>&nbsp;again.</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="nv">$ </span>curl -v http://127.0.0.1:8000/api/v1/poll/?format<span class="o">=</span>json<br />* About to connect<span class="o">()</span> to 127.0.0.1 port 8000 <span class="o">(</span><span class="c">#0)</span><br />*   Trying 127.0.0.1... connected<br />&gt; <span class="caps">GET</span> /api/v1/poll/?format<span class="o">=</span>json <span class="caps">HTTP</span>/1.1<br />&gt; User-Agent: curl/7.22.0 <span class="o">(</span>x86_64-pc-linux-gnu<span class="o">)</span> libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3<br />&gt; Host: 127.0.0.1:8000<br />&gt; Accept: */*<br />&gt; <br />* <span class="caps">HTTP</span> 1.0, assume close after body<br />&lt; <span class="caps">HTTP</span>/1.0 401 <span class="caps">UNAUTHORIZED</span><br />&lt; Date: Thu, 11 Apr 2013 00:25:46 <span class="caps">GMT</span><br />&lt; Server: WSGIServer/0.1 Python/2.7.3<br />&lt; Content-Type: text/html; <span class="nv">charset</span><span class="o">=</span>utf-8<br />&lt; <br />* Closing connection <span class="c">#0</span><br /></pre></div><br /><figcaption>Bash</figcaption></figure></div>

<p>Access Denied! Now let&#8217;s add our Access Token to the Authorize header and try&nbsp;again.</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="nv">$ </span>curl -v -H <span class="s2">&quot;Authorization: OAuth a832106c17d00fd3b9094181c598820ef3ff76f4&quot;</span> http://127.0.0.1:8000/api/v1/poll/?format<span class="o">=</span>json<br />* About to connect<span class="o">()</span> to 127.0.0.1 port 8000 <span class="o">(</span><span class="c">#0)</span><br />*   Trying 127.0.0.1... connected<br />&gt; <span class="caps">GET</span> /api/v1/poll/?format<span class="o">=</span>json <span class="caps">HTTP</span>/1.1<br />&gt; User-Agent: curl/7.22.0 <span class="o">(</span>x86_64-pc-linux-gnu<span class="o">)</span> libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3<br />&gt; Host: 127.0.0.1:8000<br />&gt; Accept: */*<br />&gt; Authorization: OAuth a832106c17d00fd3b9094181c598820ef3ff76f4<br />&gt; <br />* <span class="caps">HTTP</span> 1.0, assume close after body<br />&lt; <span class="caps">HTTP</span>/1.0 200 <span class="caps">OK</span><br />&lt; Date: Thu, 11 Apr 2013 00:27:42 <span class="caps">GMT</span><br />&lt; Server: WSGIServer/0.1 Python/2.7.3<br />&lt; Vary: Accept<br />&lt; Content-Type: application/json<br />&lt; Cache-Control: no-cache<br />&lt; <br />* Closing connection <span class="c">#0</span><br /><span class="o">{</span><span class="s2">&quot;meta&quot;</span>: <span class="o">{</span><span class="s2">&quot;limit&quot;</span>: 20, <span class="s2">&quot;next&quot;</span>: null, <span class="s2">&quot;offset&quot;</span>: 0, <span class="s2">&quot;previous&quot;</span>: null, <span class="s2">&quot;total_count&quot;</span>: 1<span class="o">}</span>, <span class="s2">&quot;objects&quot;</span>: <span class="o">[{</span><span class="s2">&quot;choices&quot;</span>: <span class="o">[{</span><span class="s2">&quot;choice_text&quot;</span>: <span class="s2">&quot;Chain&quot;</span>, <span class="s2">&quot;id&quot;</span>: 1, <span class="s2">&quot;resource_uri&quot;</span>: <span class="s2">&quot;/api/v1/choice/1/&quot;</span>, <span class="s2">&quot;votes&quot;</span>: 0<span class="o">}</span>, <span class="o">{</span><span class="s2">&quot;choice_text&quot;</span>: <span class="s2">&quot;Ring&quot;</span>, <span class="s2">&quot;id&quot;</span>: 2, <span class="s2">&quot;resource_uri&quot;</span>: <span class="s2">&quot;/api/v1/choice/2/&quot;</span>, <span class="s2">&quot;votes&quot;</span>: 0<span class="o">}</span>, <span class="o">{</span><span class="s2">&quot;choice_text&quot;</span>: <span class="s2">&quot;Watch&quot;</span>, <span class="s2">&quot;id&quot;</span>: 3, <span class="s2">&quot;resource_uri&quot;</span>: <span class="s2">&quot;/api/v1/choice/3/&quot;</span>, <span class="s2">&quot;votes&quot;</span>: 0<span class="o">}]</span>, <span class="s2">&quot;id&quot;</span>: 1, <span class="s2">&quot;pub_date&quot;</span>: <span class="s2">&quot;2013-04-10T12:38:47.337475&quot;</span>, <span class="s2">&quot;question&quot;</span>: <span class="s2">&quot;All gold everything?&quot;</span>, <span class="s2">&quot;resource_uri&quot;</span>: <span class="s2">&quot;/api/v1/poll/1/&quot;</span><span class="o">}]}</span><br /></pre></div><br /><figcaption>Bash</figcaption></figure></div>

<p>Success! Let&#8217;s try to post some data. Personally, I prefer gold all in my&nbsp;watch.</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="nv">$ </span>curl --dump-header - -H <span class="s2">&quot;Authorization: OAuth a832106c17d00fd3b9094181c598820ef3ff76f4&quot;</span> -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X put --data <span class="s1">&#39;{&quot;choice_text&quot;: &quot;Watch&quot;, &quot;id&quot;: 3, &quot;resource_uri&quot;: &quot;/api/v1/choice/3/&quot;, &quot;votes&quot;: 1}&#39;</span> http://127.0.0.1:8000/api/v1/choice/3/<br /><span class="caps">HTTP</span>/1.0 204 <span class="caps">NO</span> <span class="caps">CONTENT</span><br />Date: Thu, 11 Apr 2013 00:50:34 <span class="caps">GMT</span><br />Server: WSGIServer/0.1 Python/2.7.3<br />Vary: Accept<br />Content-Length: 0<br />Content-Type: text/html; <span class="nv">charset</span><span class="o">=</span>utf-8<br /><span class="nv">$ </span>curl --dump-header - -H <span class="s2">&quot;Authorization: OAuth a832106c17d00fd3b9094181c598820ef3ff76f4&quot;</span> http://127.0.0.1:8000/api/v1/poll/?format<span class="o">=</span>json<br /><span class="caps">HTTP</span>/1.0 200 <span class="caps">OK</span><br />Date: Thu, 11 Apr 2013 00:51:36 <span class="caps">GMT</span><br />Server: WSGIServer/0.1 Python/2.7.3<br />Vary: Accept<br />Content-Type: application/json<br />Cache-Control: no-cache<br />&nbsp;<br /><span class="o">{</span><span class="s2">&quot;meta&quot;</span>: <span class="o">{</span><span class="s2">&quot;limit&quot;</span>: 20, <span class="s2">&quot;next&quot;</span>: null, <span class="s2">&quot;offset&quot;</span>: 0, <span class="s2">&quot;previous&quot;</span>: null, <span class="s2">&quot;total_count&quot;</span>: 1<span class="o">}</span>, <span class="s2">&quot;objects&quot;</span>: <span class="o">[{</span><span class="s2">&quot;choices&quot;</span>: <span class="o">[{</span><span class="s2">&quot;choice_text&quot;</span>: <span class="s2">&quot;Chain&quot;</span>, <span class="s2">&quot;id&quot;</span>: 1, <span class="s2">&quot;resource_uri&quot;</span>: <span class="s2">&quot;/api/v1/choice/1/&quot;</span>, <span class="s2">&quot;votes&quot;</span>: 0<span class="o">}</span>, <span class="o">{</span><span class="s2">&quot;choice_text&quot;</span>: <span class="s2">&quot;Ring&quot;</span>, <span class="s2">&quot;id&quot;</span>: 2, <span class="s2">&quot;resource_uri&quot;</span>: <span class="s2">&quot;/api/v1/choice/2/&quot;</span>, <span class="s2">&quot;votes&quot;</span>: 0<span class="o">}</span>, <span class="o">{</span><span class="s2">&quot;choice_text&quot;</span>: <span class="s2">&quot;Watch&quot;</span>, <span class="s2">&quot;id&quot;</span>: 3, <span class="s2">&quot;resource_uri&quot;</span>: <span class="s2">&quot;/api/v1/choice/3/&quot;</span>, <span class="s2">&quot;votes&quot;</span>: 1<span class="o">}]</span>, <span class="s2">&quot;id&quot;</span>: 1, <span class="s2">&quot;pub_date&quot;</span>: <span class="s2">&quot;2013-04-10T12:38:47.337475&quot;</span>, <span class="s2">&quot;question&quot;</span>: <span class="s2">&quot;All gold everything?&quot;</span>, <span class="s2">&quot;resource_uri&quot;</span>: <span class="s2">&quot;/api/v1/poll/1/&quot;</span><span class="o">}]}</span><br /></pre></div><br /><figcaption>Bash</figcaption></figure></div>

<p>Now it shows our updated resource. Our <span class="caps">API</span> is now authenticating with OAuth&nbsp;2.0!</p>
<h2>Next&nbsp;Steps</h2>
<p>This brief example shows how to get started with your <span class="caps">API</span>. Taking your <span class="caps">API</span> to the next level you may have some more&nbsp;questions:</p>
<p><strong>How do I manage the scope of the tokens?</strong> Token scope for <code>django-oauth2-provider</code> can be overwritten in your django project&#8217;s <code>settings.py</code> file. Use the <a href="https://django-oauth2-provider.readthedocs.org/en/latest/api.html#provider-constants"><span class="caps">SCOPES</span></a> setting to define new token&nbsp;scope.</p>
<p><strong>How do I change the lifetime of my tokens?</strong> Similar to scope, you can set the token expiry time in the <code>settings.py</code> as well. Check the <a href="https://django-oauth2-provider.readthedocs.org/en/latest/api.html#provider-constants">EXPIRE_DELTA</a> setting to change the token expiry&nbsp;time.</p>
<p><strong>How do I manage authorization permissions?</strong> <code>DjangoAuthorization()</code> is a standard Tasty Pie class. Check the <a href="http://django-tastypie.readthedocs.org/en/latest/authorization.html#djangoauthorization">documentation</a> and <a href="https://github.com/toastdriven/django-tastypie/blob/master/tastypie/authorization.py#L131">source</a> for more&nbsp;information.</p>
<h2>Thank&nbsp;you!</h2>
<p>If you found this useful, please send me a <a href="https://twitter.com/ianalexan">tweet</a> or get in contact with me via the top of the page. Good&nbsp;luck!</p>
    <div class="post-comments">
        <h2 class="post-title">Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'ianalexandr';

            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
                </div>
            </div>
            
            <br/>
            <footer>
                <p id="footer">
                    designed in san francisco &mdash;
                    built with <a href="http://hyde.github.com/">hyde</a> &mdash;
                    licensed as <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">cc-by-nc-nd</a>
                </p>
            </footer>

        </div> <!-- /container -->

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="/media/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>

        <script src="/media/js/vendor/bootstrap.min.js"></script>

        <script src="/media/js/plugins.js"></script>
        <script src="/media/js/main.js"></script>

                <!-- asynchronous google analytics: mathiasbynens.be/notes/async-analytics-snippet
       change the UA-XXXXX-X to be your site's ID -->
<script>
    var _gaq = [['_setAccount', 'UA-32310051-1'], ['_trackPageview']];
    (function(d, t) {
    var g = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
    g.async = true;
    g.src = ('https:' == location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g, s);
    })(document, 'script');

    function clickme(link) {
		return _gaq.push(['_trackEvent', 'Outgoing Links', 'Click', link]);
  	}
</script>
            </body>
</html>
